<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Midway 开发指南 | Midway</title>
    <meta name="description" content="面向未来的 Web 全栈应用开发框架">
    
    
    <link rel="preload" href="/midway/assets/css/0.styles.957e9604.css" as="style"><link rel="preload" href="/midway/assets/js/app.26343d16.js" as="script"><link rel="preload" href="/midway/assets/js/9.f354a6a8.js" as="script"><link rel="prefetch" href="/midway/assets/js/10.f62d05bd.js"><link rel="prefetch" href="/midway/assets/js/11.78a97643.js"><link rel="prefetch" href="/midway/assets/js/12.2324f9c8.js"><link rel="prefetch" href="/midway/assets/js/13.53edddca.js"><link rel="prefetch" href="/midway/assets/js/2.5c88b4ad.js"><link rel="prefetch" href="/midway/assets/js/3.daf2be7b.js"><link rel="prefetch" href="/midway/assets/js/4.827ef9fc.js"><link rel="prefetch" href="/midway/assets/js/5.223f31bd.js"><link rel="prefetch" href="/midway/assets/js/6.1165bd8a.js"><link rel="prefetch" href="/midway/assets/js/7.5495e64f.js"><link rel="prefetch" href="/midway/assets/js/8.ad6ced6f.js">
    <link rel="stylesheet" href="/midway/assets/css/0.styles.957e9604.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/midway/" class="home-link router-link-active"><!----> <span class="site-name">Midway</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/midway/" class="nav-link">首页</a></div><div class="nav-item"><a href="/midway/guide.html" class="nav-link router-link-exact-active router-link-active">使用文档</a></div><div class="nav-item"><a href="/midway/ioc.html" class="nav-link">依赖注入手册</a></div><div class="nav-item"><a href="/midway/tool_set.html" class="nav-link">工具集</a></div><div class="nav-item"><a href="/midway/ts_start.html" class="nav-link">TS 新手指南</a></div><div class="nav-item"><a href="http://midwayjs.org/midway/api-reference/globals.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  API
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">MidwayJs 系列产品</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/midway/" class="nav-link">Midway - 面向未来的 Web 全栈框架</a></li></ul></li><li class="dropdown-item"><h4>应用管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="http://midwayjs.org/pandora/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Pandora.js - Node.js 应用管理器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>监控产品</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://github.com/midwayjs/sandbox-docker" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Sandbox - 私有化 Node.js 监控产品
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>Node.js 依赖注入模块</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="http://midwayjs.org/injection" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Injection - 让你的应用用上 IoC，体验依赖注入的感觉
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/midway/guide.html" class="nav-link router-link-exact-active router-link-active">zh-CN</a></li><li class="dropdown-item"><!----> <a href="/midway/en/guide.html" class="nav-link">en-US</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/midway/" class="nav-link">首页</a></div><div class="nav-item"><a href="/midway/guide.html" class="nav-link router-link-exact-active router-link-active">使用文档</a></div><div class="nav-item"><a href="/midway/ioc.html" class="nav-link">依赖注入手册</a></div><div class="nav-item"><a href="/midway/tool_set.html" class="nav-link">工具集</a></div><div class="nav-item"><a href="/midway/ts_start.html" class="nav-link">TS 新手指南</a></div><div class="nav-item"><a href="http://midwayjs.org/midway/api-reference/globals.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  API
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">MidwayJs 系列产品</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/midway/" class="nav-link">Midway - 面向未来的 Web 全栈框架</a></li></ul></li><li class="dropdown-item"><h4>应用管理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="http://midwayjs.org/pandora/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Pandora.js - Node.js 应用管理器
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>监控产品</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://github.com/midwayjs/sandbox-docker" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Sandbox - 私有化 Node.js 监控产品
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li class="dropdown-item"><h4>Node.js 依赖注入模块</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="http://midwayjs.org/injection" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Injection - 让你的应用用上 IoC，体验依赖注入的感觉
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/midway/guide.html" class="nav-link router-link-exact-active router-link-active">zh-CN</a></li><li class="dropdown-item"><!----> <a href="/midway/en/guide.html" class="nav-link">en-US</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Midway 开发指南</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/midway/guide.html#介绍" class="sidebar-link">介绍</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/midway/guide.html#关于-midway" class="sidebar-link">关于 Midway</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/midway/guide.html#快速上手" class="sidebar-link">快速上手</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/midway/guide.html#安装-node-环境" class="sidebar-link">安装 Node 环境</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#创建新应用" class="sidebar-link">创建新应用</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#了解目录结构" class="sidebar-link">了解目录结构</a></li></ul></li><li><a href="/midway/guide.html#快速开发引导" class="sidebar-link">快速开发引导</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/midway/guide.html#和-egg-体系相同的部分" class="sidebar-link">和 Egg 体系相同的部分</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/midway/guide.html#运行环境" class="sidebar-link">运行环境</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#配置" class="sidebar-link">配置</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#web-中间件" class="sidebar-link">Web 中间件</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#router-路由" class="sidebar-link">Router 路由</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#框架扩展" class="sidebar-link">框架扩展</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#启动自定义" class="sidebar-link">启动自定义</a></li></ul></li><li><a href="/midway/guide.html#路由和控制器" class="sidebar-link">路由和控制器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/midway/guide.html#路由装饰器" class="sidebar-link">路由装饰器</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#路由绑定" class="sidebar-link">路由绑定</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#路由优先级" class="sidebar-link">路由优先级</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#路由中间件" class="sidebar-link">路由中间件</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#一个方法挂载多个路由" class="sidebar-link">一个方法挂载多个路由</a></li></ul></li><li><a href="/midway/guide.html#框架增强注入" class="sidebar-link">框架增强注入</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/midway/guide.html#框架默认注入" class="sidebar-link">框架默认注入</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#注入插件" class="sidebar-link">注入插件</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#注入配置" class="sidebar-link">注入配置</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#注册定时任务" class="sidebar-link">注册定时任务</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#注入日志对象" class="sidebar-link">注入日志对象</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#请求作用域中的日志" class="sidebar-link">请求作用域中的日志</a></li></ul></li><li><a href="/midway/guide.html#框架扩展方法" class="sidebar-link">框架扩展方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/midway/guide.html#application-扩展" class="sidebar-link">Application 扩展</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#context-扩展" class="sidebar-link">Context 扩展</a></li></ul></li><li><a href="/midway/guide.html#应用测试" class="sidebar-link">应用测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/midway/guide.html#测试目录结构" class="sidebar-link">测试目录结构</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#测试命令" class="sidebar-link">测试命令</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#开始测试" class="sidebar-link">开始测试</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#controller-测试" class="sidebar-link">Controller 测试</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#service-测试" class="sidebar-link">Service 测试</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#使用-jest" class="sidebar-link">使用 Jest</a></li></ul></li><li><a href="/midway/guide.html#部署" class="sidebar-link">部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/midway/guide.html#构建打包" class="sidebar-link">构建打包</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#通过内置的启动文件" class="sidebar-link">通过内置的启动文件</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#egg-scripts-方式" class="sidebar-link">egg-scripts 方式</a></li><li class="sidebar-sub-header"><a href="/midway/guide.html#启动参数传递" class="sidebar-link">启动参数传递</a></li></ul></li><li><a href="/midway/guide.html#其他一些情况" class="sidebar-link">其他一些情况</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/midway/guide.html#windows-支持" class="sidebar-link">windows 支持</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="midway-开发指南"><a href="#midway-开发指南" class="header-anchor">#</a> Midway 开发指南</h1> <h2 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h2> <p>Midway 自 2013 年开始，基本保持着一年一个大版本的迭代速度进行更新，从 express 到 koa1/2，从未缺席。</p> <p>如今，集团内外的 Node.js 大环境早已脱离原有的前后端分离体系，朝着全栈的方向大步迈进，有着欣喜，有着期待，对此，MidwayJs 团队不仅仅承担着引导，支撑集团 Node.js 应用的责任，也同时通过 <code>Pandora.js</code> ，<code>Sandbox</code>  等不同形式来让应用变的更加稳定，可靠。</p> <p>在 2017 年，我们将集团内部的 Midway 5.3 升级到了基于 Koa2 的模型，全面支持了 async/await 的编码风格。</p> <p>同年年中，我们开始计划将监控和数据采集能力进行抽象剥离，形成了全新 Pandora.js 工具，不仅仅服务于 Midway，也服务于全网，乃至外部所有的 Node.js 应用。</p> <p>2018 年，MidwayJs 团队将基于 TypeScript，将 Midway6 在新的语言层面进行升级，让用户在开发体验上更近一步，对外部则是从第一个版本开始。</p> <p>为什么选择 TypeScript ? 相信<a href="https://juejin.im/post/59c46bc86fb9a00a4636f939" target="_blank" rel="noopener noreferrer"> 这篇文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 会给你一些答案。</p> <h2 id="关于-midway"><a href="#关于-midway" class="header-anchor">#</a> 关于 Midway</h2> <p>Midway (中途岛) 品牌是淘宝技术部（前淘宝UED）前端部门研发的一款基于 Node.js 的全栈开发解决方案。它将搭配团队的其他产品，Pandora.js 和 Sandbox，将 Node.js 的开发体验朝着全新的场景发展，让用户在开发过程中享受到前所未有的愉悦感。</p> <h2 id="快速上手"><a href="#快速上手" class="header-anchor">#</a> 快速上手</h2> <h3 id="安装-node-环境"><a href="#安装-node-环境" class="header-anchor">#</a> 安装 Node 环境</h3> <p>可以访问 Node.js 官网或者使用 nvm 等类似产品，不再赘述。</p> <h3 id="创建新应用"><a href="#创建新应用" class="header-anchor">#</a> 创建新应用</h3> <p>使用 <a href="https://www.npmjs.com/package/midway-init" target="_blank" rel="noopener noreferrer">midway-init<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 工具自动创建 midway 应用的目录结构:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> i midway-init -g
$ midway-init
</code></pre></div><p>通过生成的 <code>npm scripts</code> 来驱动启动命令:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> <span class="token function">install</span>
$ <span class="token function">npm</span> run dev
</code></pre></div><h3 id="了解目录结构"><a href="#了解目录结构" class="header-anchor">#</a> 了解目录结构</h3> <p>midway 的目录和 eggjs 目录非常接近，但也有所区别，不同的地方在于：</p> <ul><li>ts 源码存放于 <code>/src</code> 目录下，编译后代码存放于 <code>/dist</code> 下</li> <li>以往的 app 等都迁移至 <code>/src/app</code> 下，作为 web 层</li> <li>传统的业务逻辑等，移动到其他目录，比如 <code>/service</code></li></ul> <div class="language-plain extra-class"><pre class="language-text"><code>➜  midway6-test tree -I node_modules
.
├── README.md
├── README.zh-CN.md
├── dist                                ---- 编译后目录
├── logs                                ---- 本地日志目录
│   └── midway6-test                    ---- 日志应用名开头
│       ├── common-error.log            ---- 错误日志
│       ├── midway-agent.log            ---- agent 输出的日志
│       ├── midway-core.log             ---- 框架输出的日志
│       ├── midway-web.log              ---- koa 输出的日志
│       └── midway6-test-web.log
├── package.json
├── src                                 ---- 源码目录
│   ├── app                             ---- web 层目录
│   │   ├── controller                  ---- web 层 controller 目录
│   │   │   ├── home.ts
│   │   │   └── user.ts
│   │   ├── middleware (可选)            ---- web 层中间件目录
│   │   │   └── trace.ts
│   │   ├── public (可选)                ---- web 层静态文件目录，可以配置
│   │   ├── view (可选)
│   │   |   └── home.tpl                ---- web 层模板
│   ├── config
│   │   ├── config.default.ts
│   │   ├── config.local.ts
│   │   ├── config.prod.ts
│   │   ├── config.unittest.ts
│   │   └── plugin.ts
│   └── service                         ---- 业务逻辑层目录，自由定义
│   │   └── user.ts                     ---- 业务逻辑层，自由定义
│   ├── interface.ts                    ---- 接口定义文件，自由定义
│   ├── app.ts                          ---- 应用扩展文件，可选
│   └── agent.ts                        ---- agent 扩展文件，可选
├── test
│   └── app
│       └── controller
│           └── home.test.ts
├── tsconfig.json
└── tslint.json
</code></pre></div><p>如上，由框架约定的目录，Midway 使用 EggJs 作为 Web 层容器，承载请求控制器和传统 MVC 层的工作，这一块由于受到限制，有着一定的目录约定：</p> <ul><li><code>src/app/router.ts</code> 可选，用于配置 URL 路由规则，具体参见 <a href="https://eggjs.org/zh-cn/basics/router.html" target="_blank" rel="noopener noreferrer">Router<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li><code>src/app/controller/**</code> 用于解析用户的输入，处理后返回相应的结果，具体参见 <a href="hController">Controller</a>。</li> <li><code>src/app/middleware/**</code> 可选，用于编写中间件，具体参见 <a href="https://eggjs.org/zh-cn/basics/middleware.html" target="_blank" rel="noopener noreferrer">Middleware<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li><code>src/app/extend/**</code> 可选，用于框架的扩展，具体参见<a href="https://eggjs.org/zh-cn/basics/extend.html" target="_blank" rel="noopener noreferrer">框架扩展<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li><code>src/config/config.{env}.ts</code> 用于编写配置文件，具体参见<a href="https://eggjs.org/zh-cn/basics/config.html" target="_blank" rel="noopener noreferrer">配置<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li><code>src/config/plugin.ts</code> 用于配置需要加载的插件，具体参见<a href="https://eggjs.org/zh-cn/basics/plugin.html" target="_blank" rel="noopener noreferrer">插件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li><code>test/**</code> 用于单元测试，具体参见<a href="https://eggjs.org/zh-cn/core/unittest.html" target="_blank" rel="noopener noreferrer">单元测试<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li><code>src/app.ts</code> 和 <code>agent.ts</code> 用于自定义启动时的初始化工作，可选，具体参见<a href="https://eggjs.org/zh-cn/basics/app-start.html" target="_blank" rel="noopener noreferrer">启动自定义<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。关于<code>agent.js</code>的作用参见<a href="https://eggjs.org/zh-cn/core/cluster-and-ipc.html#agent-%E6%9C%BA%E5%88%B6" target="_blank" rel="noopener noreferrer">Agent机制<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li></ul> <p>而其他由于 Egg 插件的限制，可能有些目录也会有相应的约定，比如：</p> <ul><li><code>src/app/public/**</code> 用于放置静态资源，可选，具体参见内置插件 <a href="https://github.com/eggjs/egg-static" target="_blank" rel="noopener noreferrer">egg-static<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li><code>src/app/view/**</code> 用于放置模板文件，可选，由模板插件约定，具体参见<a href="https://eggjs.org/zh-cn/core/view.html" target="_blank" rel="noopener noreferrer">模板渲染<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li></ul> <p>我们会发现常见的代码都会存放于 <code>/src</code> 目录下，由于 ts 的特殊性，在服务器上会通过打包构建为 <code>*.js</code> 文件存放于 <code>/dist</code> 目录。将源文件和编译后文件分开是我们最开始的初衷。</p> <p>而除了 app 目录以外的其他目录，在 midway 体系下并没有严格的规定，大体可以按照逻辑分层，比如按照传统的 <code>web, biz, service, manager, dao</code> 等进行分层进行创建目录就非常不错。</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>由于 Midway 采用了自动扫描装配，依赖注入等特性，无需在特定的目录下受到限制，使得在全栈应用开发的时候，保持了不错的开发体验。</p></div> <h2 id="快速开发引导"><a href="#快速开发引导" class="header-anchor">#</a> 快速开发引导</h2> <p>想要快速上手 midway，除了需要了解一些基础的东西：</p> <ul><li>虽然可以直接用 js 的语法书写，但是你最好了解 TypeScript，这里有个 <a href="/midway/ts_start.html">快速介绍</a>。</li> <li>尽可能使用面向对象的思想来编码，它的经久不衰是有道理的，使用 class 机制能够方便的融入我们的新特性。</li> <li>了解 midway 的依赖注入体系，以及常用的装饰器，这里做了 <a href="/midway/ioc.html">依赖注入的介绍</a>。</li> <li>如果你在 midway 的文档中没有找到你想要的东西，记住可以去 <a href="https://eggjs.org/zh-cn/intro/" target="_blank" rel="noopener noreferrer">Egg 的文档找找<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，或者 <a href="https://github.com/midwayjs/midway/issues" target="_blank" rel="noopener noreferrer">向我们提 Issue<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li></ul> <h2 id="和-egg-体系相同的部分"><a href="#和-egg-体系相同的部分" class="header-anchor">#</a> 和 Egg 体系相同的部分</h2> <p>这部分的内容和 Egg 体系基本是相同的，大体不同的是后缀的区别 <code>*.ts</code>，以及根目录（midway 的根目录在 src)。</p> <h3 id="运行环境"><a href="#运行环境" class="header-anchor">#</a> 运行环境</h3> <p>目前没有做特殊处理，完全一样，查看<a href="https://eggjs.org/zh-cn/basics/env.html" target="_blank" rel="noopener noreferrer">运行环境文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="配置"><a href="#配置" class="header-anchor">#</a> 配置</h3> <p>框架支持根据环境来加载配置，定义多个环境的配置文件，唯一不同的是后缀的区别，具体环境请查看<a href="https://eggjs.org/zh-cn/basics/env.html" target="_blank" rel="noopener noreferrer">运行环境配置<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language- extra-class"><pre class="language-text"><code>src/config
|- config.default.ts
|- config.prod.ts
|- config.unittest.ts
`- config.local.ts
</code></pre></div><h3 id="web-中间件"><a href="#web-中间件" class="header-anchor">#</a> Web 中间件</h3> <p>除了目录在 <code>src/app/middleware</code> 以及后缀名为 <code>*.ts</code> ，其余完全一样，查看<a href="https://eggjs.org/zh-cn/basics/middleware.html" target="_blank" rel="noopener noreferrer">中间件文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="router-路由"><a href="#router-路由" class="header-anchor">#</a> Router 路由</h3> <p><code>src/app/router.ts</code> 文件依旧可用，推荐使用 midway 体系的 <a href="#%E8%B7%AF%E7%94%B1%E8%A3%85%E9%A5%B0%E5%99%A8">路由装饰器</a>，egg 的路由文档在<a href="https://eggjs.org/zh-cn/basics/router.html" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="框架扩展"><a href="#框架扩展" class="header-anchor">#</a> 框架扩展</h3> <p>针对框架自身的扩展点，依旧保留可用，目录变为 <code>src/app/*.ts</code>，文档查看 <a href="https://eggjs.org/zh-cn/basics/extend.html" target="_blank" rel="noopener noreferrer">框架扩展<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="启动自定义"><a href="#启动自定义" class="header-anchor">#</a> 启动自定义</h3> <p>启动自定义依旧保留可用，目录变为 <code>src/app.ts</code>，文档查看 <a href="https://eggjs.org/zh-cn/basics/app-start.html" target="_blank" rel="noopener noreferrer">启动自定义<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>如果想在 <code>app.ts</code> 中调用 IoC 中的对象，可以通过以下方法。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// app.js</span>
<span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">beforeStart</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

    <span class="token comment">// 从全局作用域拿单例对象</span>
    <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 从请求作用域拿对象</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">createAnonymousContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>requestContext<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="路由和控制器"><a href="#路由和控制器" class="header-anchor">#</a> 路由和控制器</h2> <p>midway 使用 koa-router 作为路由的承载者，同时在 ts 的语法上做了一些简化，我们将路由和控制器放在了一起，使用装饰器来标注路由。</p> <p>由于 midway 采用了 IoC 自扫描机制，使得在一定程度上弱化了目录结构约定，通过装饰器的机制，可以非常方便的进行解耦，按业务逻辑拆分等。</p> <p>现在可以在任意目录下创建 controller，不再限定 app/controller 目录，同理，其他装饰器也不限定。</p> <p>现在可以做到比如 <code>src/web/controller</code> 下放 controller，也可以按业务维度分，比如 <code>user</code> 目录，包含跟用户相关所有的 controller/service/dao 等，对微服务或者 serverless 比较友好。</p> <h3 id="路由装饰器"><a href="#路由装饰器" class="header-anchor">#</a> 路由装饰器</h3> <p>在新的 ts 体系中，我们的控制器目录为 <code>app/controller</code> ，我们在其中编写 <code>*.ts</code> 文件。例如下面的 <code>userController.ts</code> ，我们提供了一个获取用户的接口。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> provide<span class="token punctuation">,</span> controller<span class="token punctuation">,</span> inject<span class="token punctuation">,</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway'</span><span class="token punctuation">;</span>

@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">controller</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>

  @<span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'userService'</span><span class="token punctuation">)</span>
  service<span class="token operator">:</span> IUserService<span class="token punctuation">;</span>

  @<span class="token function">inject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">;</span>

  @<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token keyword">const</span> user<span class="token operator">:</span> IUserResult <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span>id<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token string">'OK'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> user<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>我们创建了 <code>@controller</code> 装饰器用来定义这个类为 Controller，同时，提供了方法装饰器用于标注请求的类型。</p> <div class="tip custom-block"><p class="custom-block-title">小贴士</p> <p>便于大家理解，<code>@controller</code> 的参数为字符串 pattern，我们会将这个值传入 <code>router.prefix(prefix)</code> 的参数中。</p></div> <p>midway 针对 web 请求，提供了和 koa-router 对应的方法装饰器，列表如下。</p> <ul><li>@get</li> <li>@post</li> <li>@del</li> <li>@put</li> <li>@patch</li> <li>@options</li> <li>@head</li> <li>@all</li></ul> <p>这几个装饰器用于修饰不同的异步方法，同时对应到了 koa-router 的相应的方法。和原有提供的控制器一样，每个控制器都为异步方法，默认参数为 koa 上下文。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">getUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO ctx...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="路由绑定"><a href="#路由绑定" class="header-anchor">#</a> 路由绑定</h3> <p>在以往框架的写法中，提供的 <code>app/router</code> 文件，虽然可以直接使用，但是由于控制器被 IoC 管控的关系，会有一些区别。</p> <p>和以往的写法不同的是，<strong>我们需要从容器中拿到对应的控制器实例，并绑定到路由的 pattern 上</strong>。</p> <p>假如我们有一个控制器，同时没有提供 <code>@controller</code> 装饰器，表明他不是一个控制器，在应用初始化时不会自动绑定到某个路由上，但是由于有 <code>@provide</code> 装饰器，他会被 IoC 容器所加载。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// app/controller/api.ts</span>

@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseApi</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'index'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>假如我们希望这个控制器可以被外部的路由使用。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// app/router.ts</span>

<span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/api/index'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span><span class="token function">generateController</span><span class="token punctuation">(</span><span class="token string">'baseApi.index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>midway 扩展了一个 <code>app.generateController</code> 的方法来简化绑定的这个步骤，参数为 <code>ClassName.methodName</code> 的字符串形式。</p> <h3 id="路由优先级"><a href="#路由优先级" class="header-anchor">#</a> 路由优先级</h3> <p>在单页应用下，经常会出现 <code>/*</code> 这种路由，在原本的路由文件中，我们可以通过调整代码的顺序，来使的路由的匹配顺序发生变化。而由于使用了装饰器的关系，在新的体系无法控制文件扫描和加载顺序，这就使得路由匹配的顺序不可控。</p> <p>midway 提供了 <code>@priority(priority: number)</code> 装饰器，用于修饰 class，定义路由的优先级，默认的路由优先级为 <code>0</code>，可以设置负数让优先级降低。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">priority</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
@<span class="token function">controller</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token punctuation">{</span>

  @<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/hello'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/*'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'world'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="路由中间件"><a href="#路由中间件" class="header-anchor">#</a> 路由中间件</h3> <p>有时候我们会有在特定路由上加载中间件的需求，在之前的版本只能通过定义 <code>router.ts</code> 文件来解决部分需求，而在新版本中，我们扩展了装饰器的能力，使之可以在特定场景下增加 web 中间件。</p> <p>现在可以提供一个 middleware（任意目录），比如 <code>src/app/middleware/api.ts</code>。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Middleware<span class="token punctuation">,</span> WebMiddleware<span class="token punctuation">,</span> provide<span class="token punctuation">,</span> config <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway'</span><span class="token punctuation">;</span>

@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ApiMiddleware</span> <span class="token keyword">implements</span> <span class="token class-name">WebMiddleware</span> <span class="token punctuation">{</span>

  @<span class="token function">config</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
  helloConfig<span class="token punctuation">;</span>

  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Middleware <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>api <span class="token operator">=</span> <span class="token string">'222'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>helloConfig<span class="token punctuation">.</span>b<span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>由于是 class，依旧可以使用 inject/plugin/config 等装饰器修饰。</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>推荐使用 <code>WebMiddleware</code> 接口来规范你的 web 中间件。</p></div> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">controller</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>middleware<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'homeMiddleware'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">My</span> <span class="token punctuation">{</span>

  @<span class="token function">inject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">;</span>

  @<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>middleware<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'apiMiddleware'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>home <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>api<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 <code>@controller</code> 和 <code>@get/post</code> 等路由装饰器上都提供了 middleware 参数。</p> <p>这里的 middleware 参数是一个数组，可以传多个字符串或者 <code>koa middleware</code>，如果是字符串，会从 IoC 容器中获取对应的 <code>WebMiddleware</code> 接口实例的 <code>resolve</code> 方法的结果。</p> <p>也可以直接传递 <code>koa middleware</code>。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> mw<span class="token operator">:</span> <span class="token function-variable function">Middleware</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>home <span class="token operator">=</span> <span class="token string">'4444'</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> newMiddleware <span class="token operator">=</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter">Middleware</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>api <span class="token operator">=</span> data<span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">controller</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>middleware<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'homeMiddleware'</span><span class="token punctuation">,</span> mw<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">My</span> <span class="token punctuation">{</span>

  @<span class="token function">inject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">;</span>

  @<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>middleware<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'apiMiddleware'</span><span class="token punctuation">,</span> <span class="token function">newMiddleware</span><span class="token punctuation">(</span><span class="token string">'5555'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>home <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>api<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>这种方式只用于某个路由下的中间件，如果你希望使用全局中间件，那么请依旧使用 egg 的那种形式。</p></div> <h4 id="中间件注入的特殊性"><a href="#中间件注入的特殊性" class="header-anchor">#</a> 中间件注入的特殊性</h4> <p>由于中间件在生命周期的特殊性，会在应用请求前就被加载（绑定）到路由上，所以无法和上下文关联。</p> <p>中间件类固定为单例（Singleton），所有注入的内容都为单例，包括但不限于 @config/@logger/@plugin 等。</p> <p>这意味着你可以注入一个 service，但是这个 service 中无法注入 ctx 属性。</p> <p>这个时候，你必须在 <code>resolve</code> 方法中，通过调用 <code>ctx.requestContext.getAsync('xxx')</code> 的方式来创建请求作用域实例，和上下文绑定。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ApiMiddleware</span> <span class="token keyword">implements</span> <span class="token class-name">WebMiddleware</span> <span class="token punctuation">{</span>

  @<span class="token function">inject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  myService<span class="token punctuation">;</span>  <span class="token comment">// 由于中间件实例属于单例，这个实例即使注入也无法获取到 ctx</span>

  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Middleware <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 必须通过从请求作用域中获取对象的方式，来绑定上下文</span>
      ctx<span class="token punctuation">.</span>service <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>requestContext<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span><span class="token string">'myService'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="一个方法挂载多个路由"><a href="#一个方法挂载多个路由" class="header-anchor">#</a> 一个方法挂载多个路由</h3> <p>新版本实现了在同一方法上可以挂载多个路由的能力。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">controller</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>middleware<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'homeMiddleware'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">My</span> <span class="token punctuation">{</span>

  @<span class="token function">inject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">;</span>

  @<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>middleware<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'apiMiddleware'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/data'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>home <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>api <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样请求进来， post 和 get 拿到的结果是不一样的（get请求挂载了额外的中间件）。</p> <h2 id="框架增强注入"><a href="#框架增强注入" class="header-anchor">#</a> 框架增强注入</h2> <p>midway 默认使用 <a href="http://web.npm.alibaba-inc.com/package/injection" target="_blank" rel="noopener noreferrer">injection<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 这个包来做依赖注入，虽然 <code>@inject</code> 装饰器能满足大多数业务的需求，但是对于框架来说，还有需要扩展和使用的地方，比如插件，配置等等。</p> <h3 id="框架默认注入"><a href="#框架默认注入" class="header-anchor">#</a> 框架默认注入</h3> <p>在默认情况下，框架会注入一些属性，方便开发，这些属性都能通过 <code>@inject</code> 装饰器来注入。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">inject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
appDir<span class="token punctuation">;</span> <span class="token comment">// 当前项目的根目录</span>

@<span class="token function">inject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
baseDir<span class="token punctuation">;</span>  <span class="token comment">// 当前项目基础目录 src 或者 dist，绝对路径</span>

@<span class="token function">inject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ctx<span class="token punctuation">;</span> <span class="token comment">// 请求作用域，koa ctx</span>

@<span class="token function">inject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
logger<span class="token punctuation">;</span> <span class="token comment">// 请求作用域，ContextLogger</span>
</code></pre></div><h3 id="注入插件"><a href="#注入插件" class="header-anchor">#</a> 注入插件</h3> <p>midway 除了支持 eggjs 原本的 app.xx 的插件用法，为了和框架解耦，同时，也可以通过 <code>@plugin</code> 装饰器来注入插件。</p> <p>我们以 <code>egg-jwt</code> 插件为例，这个插件提供了 <code>app.jwt</code> 对象，而 <code>@plugin</code> 装饰器，则是类似于直接从 app 对象上拿属性。</p> <p>比如 <code>@plugin('jwt')</code>，其实就是 <code>app['jwt']</code>，这样的写法，就可以和 app 对象进行解耦。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> provide<span class="token punctuation">,</span> plugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway'</span><span class="token punctuation">;</span>

@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseService</span> <span class="token punctuation">{</span>

  @<span class="token function">plugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  jwt<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre></div><h3 id="注入配置"><a href="#注入配置" class="header-anchor">#</a> 注入配置</h3> <p>在 midway 中不同环境的 config 都会挂载到 app.config 中，但是不是所有的业务逻辑都会依赖 app 对象，所以我们构造了 <code>@config</code> 装饰器来获取配置对象。</p> <p>假如 <code>config.default.ts</code> 中有一些代码。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> hello <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> provide<span class="token punctuation">,</span> config <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway'</span><span class="token punctuation">;</span>

@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseService</span> <span class="token punctuation">{</span>

  @<span class="token function">config</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
  config<span class="token punctuation">;</span>   <span class="token comment">// 1</span>

<span class="token punctuation">}</span>
</code></pre></div><p>通过这样，我们可以把 config 中的值直接注入到业务逻辑中。</p> <h3 id="注册定时任务"><a href="#注册定时任务" class="header-anchor">#</a> 注册定时任务</h3> <p>midway 的定时任务是基于 <a href="https://eggjs.org/zh-cn/basics/schedule.html" target="_blank" rel="noopener noreferrer">egg 定时任务<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>提供了更多 typescript 以及装饰器方面的支持。定时任务可以存放在任意目录，例如 src/schedule 目录下，可以配置定时任务的属性和要执行的方法。例如：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// src/schedule/hello.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> provide<span class="token punctuation">,</span> schedule<span class="token punctuation">,</span> CommonSchedule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway'</span><span class="token punctuation">;</span>

@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  interval<span class="token operator">:</span> <span class="token number">2333</span><span class="token punctuation">,</span> <span class="token comment">// 2.333s 间隔</span>
  <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'worker'</span><span class="token punctuation">,</span> <span class="token comment">// 指定某一个 worker 执行</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HelloCron</span> <span class="token keyword">implements</span> <span class="token class-name">CommonSchedule</span> <span class="token punctuation">{</span>

  <span class="token comment">// 定时执行的具体任务</span>
  <span class="token keyword">async</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>pid<span class="token punctuation">,</span> <span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>推荐使用 <code>CommonSchedule</code> 接口来规范你的计划任务类。</p></div> <h3 id="注入日志对象"><a href="#注入日志对象" class="header-anchor">#</a> 注入日志对象</h3> <p>在原有逻辑中，日志对象也都挂载在 app.loggers 中，通过在 config 中配置的 key 来生成不同的日志实例对象，比如插件的日志，链路的日志等。</p> <p>比如自定义一个日志 <code>myLogger</code>，这个时候，日志的 key 则为 <code>myLogger</code> 。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">appInfo</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    customLogger<span class="token operator">:</span> <span class="token punctuation">{</span>
      myLogger<span class="token operator">:</span> <span class="token punctuation">{</span>
        file<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>appInfo<span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token string">'logs/xx.log'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这个时候可以用 <code>@logger</code> 来获取日志实例。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> provide<span class="token punctuation">,</span> logger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway'</span><span class="token punctuation">;</span>

@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseService</span> <span class="token punctuation">{</span>

  @<span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">'myLogger'</span><span class="token punctuation">)</span>
  logger<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre></div><h3 id="请求作用域中的日志"><a href="#请求作用域中的日志" class="header-anchor">#</a> 请求作用域中的日志</h3> <p>midway 在新版本中默认对所有对象开启了请求作用域，处于该作用域下的对象，都会包含一个默认的日志对象。</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>该 logger 对象是在请求链路开始就埋入到 IoC 容器中，所以可以通过 @inject 可以获取该对象， key 就为 logger，如果和属性同名则可以不填。</p></div> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseService</span> <span class="token punctuation">{</span>

  @<span class="token function">inject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  logger<span class="token punctuation">;</span>

  <span class="token comment">// 也可以直接传入 key</span>
  <span class="token comment">// @inject('logger')</span>
  <span class="token comment">// logger;</span>


<span class="token punctuation">}</span>
</code></pre></div><h2 id="框架扩展方法"><a href="#框架扩展方法" class="header-anchor">#</a> 框架扩展方法</h2> <p>抛开 eggjs 对 koa 的 application/context/request/response 的扩展点，midway 在 IoC 方面也做了一些扩展。</p> <h3 id="application-扩展"><a href="#application-扩展" class="header-anchor">#</a> Application 扩展</h3> <p>具体接口见 <a href="https://midwayjs.org/midway/api-reference/classes/midwayapplication.html" target="_blank" rel="noopener noreferrer">API 文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><strong>baseDir</strong></p> <p>由于 typescript 的关系，midway 的 app.baseDir 在开发时期指向了 <code>/src</code> 目录，而在构建之后部署阶段指向了 <code>/dist</code> 目录。</p> <p><strong>appDir</strong></p> <p>针对 baseDir 修改的情况，我们引入了一个新的 <code>app.appDir</code> 属性，用于指向应用根目录。</p> <p><strong>applicationContext</strong></p> <p><code>app.applicationContext</code> 用于全局作用域的 IoC 容器，所有的单例对象都存放于该属性，可以从中获取到单例对象。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">await</span> app<span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>pluginContext</strong></p> <p>插件容器，用于存在现有的所有挂载在 app 上的插件实例。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">await</span> app<span class="token punctuation">.</span>pluginContext<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span><span class="token string">'插件名'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="context-扩展"><a href="#context-扩展" class="header-anchor">#</a> Context 扩展</h3> <p><strong>requestContext</strong></p> <p>针对请求作用域的情况，我们在 context 对象上扩展了一个 <code>requestContext</code> 属性。</p> <p>和 <code>applicationContext</code> 相同，也是 IoC 容器，用于存放一次请求链路上的对象，当请求结束后，该容器会被清空。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">await</span> ctx<span class="token punctuation">.</span>requestContext<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="应用测试"><a href="#应用测试" class="header-anchor">#</a> 应用测试</h2> <p>经过大量的实践，我们沉淀出了一套标准的测试工具集。</p> <ul><li>测试工具包 <a href="https://www.npmjs.com/package/midway-bin" target="_blank" rel="noopener noreferrer">midway-bin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>测试框架 mocha</li> <li>测试断言库 assert/chai</li> <li>测试模拟 <a href="https://www.npmjs.com/package/midway-mock" target="_blank" rel="noopener noreferrer">midway-mock<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="测试目录结构"><a href="#测试目录结构" class="header-anchor">#</a> 测试目录结构</h3> <p>我们约定 <code>test</code> 目录为存放所有测试脚本的目录，测试所使用到的 <code>fixtures</code> 和相关辅助脚本都应该放在此目录下。</p> <p>测试脚本文件统一按 <code>${filename}.test.ts</code> 命名，必须以 <code>.test.ts</code> 作为文件后缀。</p> <p>一个应用的测试目录示例：</p> <div class="language-plain extra-class"><pre class="language-text"><code>test
├── controller
│   └── home.test.ts
├── hello.test.ts
└── service
    └── user.test.ts

</code></pre></div><h3 id="测试命令"><a href="#测试命令" class="header-anchor">#</a> 测试命令</h3> <p>在脚手架中，我们已经将常见的命令进行内置，可能略微有些不同，大致代码如下。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;midway-bin test --ts&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;cov&quot;</span><span class="token operator">:</span> <span class="token string">&quot;midway-bin cov --ts&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><span data-type="color" style="color:rgb(88, 88, 88)"><span data-type="background" style="background-color:rgb(255, 255, 255)">然后就可以按标准的 </span></span><code>npm test</code><span data-type="color" style="color:rgb(88, 88, 88)"><span data-type="background" style="background-color:rgb(255, 255, 255)"></span></span>来运行测试了。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token builtin class-name">test</span>

<span class="token operator">&gt;</span> unittest-example@ <span class="token builtin class-name">test</span> /Users/harry/midwayj/examples/unittest
<span class="token operator">&gt;</span> midway-bin <span class="token builtin class-name">test</span> --ts

  test/hello.test.ts
    ✓ should work

  <span class="token number">1</span> passing <span class="token punctuation">(</span>10ms<span class="token punctuation">)</span>

</code></pre></div><h3 id="开始测试"><a href="#开始测试" class="header-anchor">#</a> 开始测试</h3> <p>在测试运行之前，我们首先要创建应用的一个 app 实例， 通过它来访问需要被测试的 Controller、Middleware、Service 等应用层代码。</p> <p>通过 <code>midway-mock</code>，结合 Mocha 的 <code>before</code> 钩子就可以便捷地创建出一个 app 实例。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// test/controller/home.test.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> mm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway-mock'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'test/controller/home.test.ts'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> app<span class="token punctuation">;</span>
  <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建当前应用的 app 实例</span>
    app <span class="token operator">=</span> mm<span class="token punctuation">.</span><span class="token function">app</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待 app 启动成功，才能执行测试用例</span>
    <span class="token keyword">return</span> app<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这样我们就拿到了一个 app 的引用，接下来所有测试用例都会基于这个 app 进行。 更多关于创建 app 的信息请查看 <a href="https://github.com/eggjs/egg-mock#options" target="_blank" rel="noopener noreferrer">mm.app(options)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 文档。</p> <p>每一个测试文件都需要这样创建一个 app 实例非常冗余，因此 <code>midway-mock</code> 提供了一个 bootstrap 文件，可以直接从它上面拿到我们所常用的实例：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// test/controller/home.test.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway-mock/bootstrap'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'test/controller/home.test.ts'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// test cases</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="controller-测试"><a href="#controller-测试" class="header-anchor">#</a> Controller 测试</h3> <p>我们可以通过 app.httpRequest() <a href="https://github.com/visionmedia/supertest" target="_blank" rel="noopener noreferrer">SuperTest<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 发起一个真实的 HTTP 请求来进行测试。app.httpRequest() 是 midway-mock 封装的 SuperTest 请求实例。</p> <p>例如我们要给 <code>app/controller/home.ts</code>：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> controller<span class="token punctuation">,</span> <span class="token keyword">get</span><span class="token punctuation">,</span> provide <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway'</span><span class="token punctuation">;</span>

@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">controller</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token punctuation">{</span>
  @<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Welcome to midwayjs!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>写一个完整的单元测试，它的测试代码 <code>test/controller/home.test.ts</code> 如下：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway-mock/bootstrap'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'test/controller/home.test.ts'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should GET /'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对 app 发起 `GET /` 请求</span>
    <span class="token keyword">return</span> app
      <span class="token punctuation">.</span><span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">'Welcome to midwayjs!'</span><span class="token punctuation">)</span> <span class="token comment">// 期望 body 是 hello world</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 期望返回 status 200</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>通过基于 SuperTest 的 app.httpRequest() 可以轻松发起 GET、POST、PUT 等 HTTP 请求，并且它有非常丰富的请求数据构造接口，请查看 <a href="https://github.com/visionmedia/supertest#getting-started" target="_blank" rel="noopener noreferrer">SuperTest<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 文档。</p> <h3 id="service-测试"><a href="#service-测试" class="header-anchor">#</a> Service 测试</h3> <p>由于 midway 提倡使用 IoC 的方式来定义 service，所以编码与测试都与 eggjs 有明显的区别。</p> <p>例如 <code>src/service/user.ts</code>:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> provide <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IUserService<span class="token punctuation">,</span> IUserOptions<span class="token punctuation">,</span> IUserResult <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../interface'</span><span class="token punctuation">;</span>

<span class="token comment">// 装载 service 到 IoC 容器</span>
@<span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'userService'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token keyword">implements</span> <span class="token class-name">IUserService</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">getUser</span><span class="token punctuation">(</span>options<span class="token operator">:</span> IUserOptions<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>IUserResult<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token operator">&lt;</span>IUserResult<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 10ms 之后返回用户数据</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          id<span class="token operator">:</span> options<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
          username<span class="token operator">:</span> <span class="token string">'mockedName'</span><span class="token punctuation">,</span>
          phone<span class="token operator">:</span> <span class="token string">'12345678901'</span><span class="token punctuation">,</span>
          email<span class="token operator">:</span> <span class="token string">'xxx.xxx@xxx.com'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>编写单元测试 <code>test/service/user.test.ts</code>：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'midway-mock/bootstrap'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IUserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../src/interface'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'test/service/user.test.ts'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'#getUser'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 取出 userService</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span>getAsync<span class="token operator">&lt;</span>IUserService<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">'userService'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>id <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>username <span class="token operator">===</span> <span class="token string">'mockedName'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>app.applicationContext 是 IoC 容器的应用上下文, 通过它可以异步取出注入的 service，并使用 service 进行测试。完整 demo 可以参见 <a href="https://github.com/Lellansin/midway-test-demo" target="_blank" rel="noopener noreferrer">midway-test-demo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="使用-jest"><a href="#使用-jest" class="header-anchor">#</a> 使用 Jest</h3> <p>Midway 在单元测试框架上，不仅支持 Mocha，也对 Jest 做了相应支持。具体使用步骤如下：</p> <p>1.在项目根目录安装以下依赖：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> <span class="token function">install</span> jest @types/jest ts-jest -D
</code></pre></div><ol start="2"><li>修改 <code>tsconfig.json</code>，避免 Mocha 与 Jest 的类型定义文件冲突</li></ol> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;compilerOptions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;types&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;jest&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>在项目根目录下新增 <code>jest.config.js</code> 文件，内容如下：</li></ol> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">module</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  preset<span class="token operator">:</span> <span class="token string">'ts-jest'</span><span class="token punctuation">,</span>
  testEnvironment<span class="token operator">:</span> <span class="token string">'midway-bin/jest/env.js'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ol start="4"><li>配置 npm scripts，修改 test 命令</li></ol> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jest --forceExit&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="5"><li>运行 npm scripts，即可使用 Jest 完成单测</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> run <span class="token builtin class-name">test</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>我们也提供了可运行 demo 供大家参考：<a href="https://github.com/midwayjs/midway-examples/tree/4a22e07c661a01aa05221fe56e11dce6c9bfc604/demo-unittest-jest" target="_blank" rel="noopener noreferrer">demo-unittest-jest<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <h2 id="部署"><a href="#部署" class="header-anchor">#</a> 部署</h2> <h3 id="构建打包"><a href="#构建打包" class="header-anchor">#</a> 构建打包</h3> <p>由于 TypeScript 的特殊性，本地开发可以有 ts-node 等类似的工具进行开发，而在服务器端运行的时候，我们希望可以通过 js 来运行，这中间就需要编译工具。</p> <p>幸好 TypeScript 官方提供了 tsc 工具来帮助这个过程，而编译时会自动调用 <code>tsconfig.json</code> 来做一些编译时处理，midway 默认提供了一份该文件，用户也可以进行自定义。</p> <p>同时，在脚手架中，我们提供了 <code>build</code> 命令帮助用户更好的生成文件。</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>推荐在发布前本地进行 build，并通过 npm run start_build 进行启动尝试，减少服务器端构建错误。</p></div> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token string">&quot;start_build&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;npm run build &amp;&amp; NODE_ENV=development midway-bin dev&quot;</span>
</code></pre></div><p>通过 start_build 启动的应用，将会自动本地编译，然后启动 dist 目录中的文件。</p> <p>如果有一些自定义的文件需要在打包时拷贝，可以参考 <a href="/midway/tool_set.html#build-命令">自定义打包</a></p> <h3 id="通过内置的启动文件"><a href="#通过内置的启动文件" class="header-anchor">#</a> 通过内置的启动文件</h3> <p>midway 提供了一个内置的 <code>server.js</code> 来作为应用的启动入口，在大部分情况下，可以通过直接 require 该文件来进行启动。</p> <p>比如使用 pm2 的场景下。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// xxx.js</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'midway/server'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>或者使用我们 pandora 的场景下，会生成 procfile.js 文件，内容如下。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">pandora</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  pandora
    <span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token string">'[your app name]'</span><span class="token punctuation">,</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'midway/server'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>通过内置的 server 文件，可以自动启动应用。</p> <h3 id="egg-scripts-方式"><a href="#egg-scripts-方式" class="header-anchor">#</a> egg-scripts 方式</h3> <p>在以往的 egg 应用中，egg-scripts 也可以直接启动，但是不支持 <a href="#%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92">启动参数传递</a> 。</p> <p>具体的文档请查看 <a href="https://eggjs.org/zh-cn/core/deployment.html" target="_blank" rel="noopener noreferrer">使用 egg-scripts 应用部署<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="启动参数传递"><a href="#启动参数传递" class="header-anchor">#</a> 启动参数传递</h3> <p>我们设计了一个机制，在 package.json 中配置服务器设置，只有依赖了 <code>midway/server</code> 文件才可以使用。</p> <p>支持的参数见 <a href="https://github.com/eggjs/egg-cluster/blob/master/lib/master.js#L33" target="_blank" rel="noopener noreferrer">启动参数<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，同时，midway 框架额外增加了几个参数。</p> <ul><li>typescript {boolean} 如果为true，则会开启 ts 模式，加载 src 或者 dist 目录，默认内部会进行判断，无需手动处理</li> <li>srcDir {string} 源码路径，默认为 src</li> <li>targetDir {string} 编译后路径，默认为 dist</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;midway-server-options&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;workers&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">3000</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果觉得不足，还可以使用 js 或者 json 文件进行定义。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;midway-server-options&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./server.json&quot;</span>    <span class="token comment">// xxx.js</span>
<span class="token punctuation">}</span>

<span class="token comment">// in json</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;workers&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token comment">// in js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  workers<span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="其他一些情况"><a href="#其他一些情况" class="header-anchor">#</a> 其他一些情况</h2> <h3 id="windows-支持"><a href="#windows-支持" class="header-anchor">#</a> windows 支持</h3> <p>由于在 windows 上开发体验不是特别友好，以及一些库缺乏支持，在大部分情况下，我们优先推荐在 mac/linux 下开发 Node.js 应用。</p> <p>需要注意的是，由于 windows 对设置环境变量的同步，默认生成的脚手架可能需要调整，主要是环境变量的部分。</p> <p>比如开发命令，在设置环境的时候需要使用 <code>set</code> 以及中间需要增加 <code>&amp;&amp;</code> 以连接命令。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;set NODE_ENV=local &amp;&amp; midway-bin dev --ts&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/midway/assets/js/app.26343d16.js" defer></script><script src="/midway/assets/js/9.f354a6a8.js" defer></script>
  </body>
</html>
